<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MEXC Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #f8f9fa, #e0f2f1);
      color: #333;
    }

    h1, h2, h4 {
      color: #0d47a1;
      font-weight: 600;
    }

    .card {
      background-color: #ffffff;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .btn-primary {
      background-color: #1565c0;
      border-color: #1565c0;
    }

    .btn-primary:hover {
      background-color: #0d47a1;
    }

    .btn-success:hover {
      background-color: #2e7d32;
    }

    table th {
      background-color: #1565c0;
      color: white;
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f1f8ff;
    }

    .table-striped tbody tr:nth-of-type(even) {
      background-color: #e3f2fd;
    }

    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .btn-group .btn {
      margin-right: 8px;
    }

    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      font-weight: 500;
      color: #0d47a1;
    }

    @media (max-width: 768px) {
      .btn-group {
        display: flex;
        flex-direction: column;
      }

      .btn-group .btn {
        margin-bottom: 8px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="spinner-overlay" id="spinner">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container py-5">
    <h2 class="text-center mb-5">üìä MEXC Trading Dashboard</h2>

    <!-- EXPORT BUTTONS -->
    <div class="d-flex flex-wrap justify-content-between mb-4">
      <!-- Backtest Export -->
      <div class="btn-group">
        <a href="/download-csv" class="btn btn-success {% if not results %}disabled{% endif %}" title="{% if not results %}Run a backtest first{% endif %}">
          ‚¨áÔ∏è Backtest CSV
        </a>
        <a href="/download-json" class="btn btn-success {% if not results %}disabled{% endif %}" title="{% if not results %}Run a backtest first{% endif %}">
          ‚¨áÔ∏è Backtest JSON
        </a>
      </div>

      <!-- Live Trade Export -->
      <div class="btn-group">
        <a href="{{ url_for('download_live_csv') }}" class="btn btn-info text-white {% if not trades %}disabled{% endif %}" title="{% if not trades %}No live trades to export{% endif %}">
          ‚¨áÔ∏è Live CSV
        </a>
        <a href="{{ url_for('download_live_json') }}" class="btn btn-info text-white {% if not trades %}disabled{% endif %}" title="{% if not trades %}No live trades to export{% endif %}">
          ‚¨áÔ∏è Live JSON
        </a>
      </div>
    </div>

    <!-- BACKTESTING FORM -->
    <div class="card p-4 mb-5">
      <h4 class="section-title">üìÅ Run Backtest</h4>
      <form method="POST" action="/" onsubmit="showSpinner()">
        <input type="hidden" name="form_type" value="backtest" />
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Symbols</label>
            <input type="text" class="form-control" name="symbols" value="BTCUSDT,ETHUSDT" placeholder="e.g. BTCUSDT,ETHUSDT" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="start_date" />
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" name="end_date" />
          </div>
          <div class="col-md-2 d-grid align-items-end">
            <button class="btn btn-primary">Run</button>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-3">
            <label class="form-label">Starting Balance</label>
            <input type="number" class="form-control" name="starting_balance" value="10000" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Polygon.io API Key</label>
            <input type="password" class="form-control" name="api_key" />
          </div>
          <div class="col-md-2">
            <label class="form-label">Rise Threshold (%)</label>
            <input type="number" step="0.1" class="form-control" name="rise_threshold" value="3.0" />
          </div>
          <div class="col-md-2">
            <label class="form-label">Drop Threshold (%)</label>
            <input type="number" step="0.1" class="form-control" name="drop_threshold" value="-0.5" />
          </div>
          <div class="col-md-2">
            <label class="form-label">Trailing Stop (%)</label>
            <input type="number" step="0.1" class="form-control" name="trailing_stop" value="0.5" />
          </div>
        </div>
      </form>
    </div>

    {% if results %}
    <!-- BACKTEST RESULTS -->
    <div class="card p-4 mb-4">
      <h4 class="section-title">üìà Backtest Results</h4>
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>PnL ($)</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
          <tr>
            <td>{{ r.symbol }}</td>
            <td>{{ r.entry }}</td>
            <td>{{ r.exit }}</td>
            <td class="{{ 'text-success' if r.pnl >= 0 else 'text-danger' }}">{{ r.pnl }}</td>
            <td>{{ r.reason }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PNL CHART -->
    <div class="card p-4 mb-5">
      <h4 class="section-title">üìä PnL Over Time</h4>
      <canvas id="pnlChart" height="100"></canvas>
    </div>
    {% endif %}

    <!-- LIVE TRADE EXECUTION -->
    <div class="card p-4 mb-4">
      <h4 class="section-title">üéØ Live Trade Execution</h4>
      <form method="POST" action="/live" class="row g-3">
        <input type="hidden" name="form_type" value="live" />
        <div class="col-md-4">
          <input class="form-control" name="symbol" placeholder="e.g. BTCUSDT" required />
        </div>
        <div class="col-md-3">
          <input class="form-control" name="quantity" placeholder="e.g. 0.01" required />
        </div>
        <div class="col-md-3">
          <select class="form-select" name="side">
            <option>BUY</option>
            <option>SELL</option>
          </select>
        </div>
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary">Execute</button>
        </div>
      </form>
      {% if message %}
      <p class="mt-3 text-success"><strong>{{ message }}</strong></p>
      {% endif %}
    </div>

    <!-- ACTIVE POSITIONS -->
    <div class="card p-4 mb-4">
      <h4 class="section-title">üìà Active Positions</h4>
      {% if positions %}
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Qty</th>
            <th>Entry Price</th>
            <th>Entry Time</th>
          </tr>
        </thead>
        <tbody>
          {% for s, p in positions.items() %}
          <tr>
            <td>{{ s }}</td>
            <td>{{ p.quantity }}</td>
            <td>{{ p.entry_price }}</td>
            <td>{{ p.time }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No active positions</p>
      {% endif %}
    </div>
<!-- TRADE HISTORY -->
<div class="card p-4 mb-5">
  <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>Trade History</h5>
  <div style="overflow-x: auto; width: 100%;">
    {% if trades %}
      <table class="table table-bordered text-center align-middle mb-0" style="min-width: 600px;">
        <thead>
          <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Qty</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
          {% for t in trades %}
          <tr>
            <td>{{ t.timestamp }}</td>
            <td>{{ t.symbol }}</td>
            <td>{{ t.side }}</td>
            <td>{{ t.quantity }}</td>
            <td>{{ t.price }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No trades yet</p>
    {% endif %}
  </div>
</div>


  {% if results %}
  <script>
    const ctx = document.getElementById('pnlChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ results | map(attribute='symbol') | list | tojson }},
        datasets: [{
          label: 'Profit/Loss ($)',
          data: {{ results | map(attribute='pnl') | list | safe }},
          borderColor: '#1565c0',
          backgroundColor: 'rgba(21, 101, 192, 0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  </script>
  {% endif %}

  <script>
    function showSpinner() {
      document.getElementById("spinner").style.display = "flex";
    }
  </script>
</body>
</html>
